---
title: "ginã®validatorã§panic: Bad field type **ãŒå‡ºãŸæ™‚ã®å¯¾ç­–"
emoji: "ğŸˆ"
type: "tech"
topics:
  - "go"
  - "gin"
published: true
published_at: "2021-02-03 17:38"
---


# TL;DR

çµè«–ã¯ç‹¬è‡ªãƒ«ãƒ¼ãƒ«ã®åå‰ãŒ`unique`ã«ãªã£ã¦ã„ãŸç‚ºã€ã§ã—ãŸã€‚
ãªãœã‹ä¸Šæ›¸ãã§ãã¦ãŠã‚‰ãšã€uniqueãƒ«ãƒ¼ãƒ«ã«ã®ã£ã¨ã£ã¦å‡¦ç†ã•ã‚Œã¦ã„ãŸç‚ºãªæ§˜ã§ã™ã­ã€‚
ã¡ã‚ƒã‚“ã¨åä»˜ã‘ã—ã¾ã™ã€œã€œã€œã€œ


# èµ·ã“ã£ãŸã“ã¨

ã„ã¤ã‚‚ã®æ§˜ã«ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè£…ã—ã¦ã€ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã€commitå‰ã«ä¸€å›ãƒ†ã‚¹ãƒˆã‚’å›ã—ã¦ã€pushã—ã‚ˆã†ã€ãã†æ€ã£ãŸæ™‚ï¼
```sh
panic: Bad field type int [recovered]
	panic: Bad field type int

goroutine 42 [running]:
testing.tRunner.func1.2(0x74d880, 0xc00031fd60)
	/usr/local/go/src/testing/testing.go:1144 +0x332

ã€œã€œã€œã€œã€œã€€ç•¥ã€€ã€œã€œã€œã€œã€œã€œ

	/go/src/github.com/Diwamoto/yource/model/UserModel.go:52 +0x14a
main/test/model.TestValidateUser(0xc000383200)
	/go/src/github.com/Diwamoto/yource/test/model/UserModel_test.go:98 +0x118
testing.tRunner(0xc000383200, 0x7cbba0)
	/usr/local/go/src/testing/testing.go:1194 +0xef
created by testing.(*T).Run
	/usr/local/go/src/testing/testing.go:1239 +0x2b3
FAIL	main/test/model	0.286s

```

ãªã‚“ã‚„ã“ã‚Œã€ã€ã€
ã¨ã‚Šã‚ãˆãšç›´ãã†ã€‚ã€‚ã€‚

# è§£æ±ºã—ã¦ã„ã

goã¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æ§‹é€ ãŒã¨ã¦ã‚‚ç°¡å˜ã«ä½œã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã¨ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒãƒã‚¸ã§ã¿ã‚„ã™ã„ã§ã™ã€‚
ã“ã“ã§ã¯goã®é–‹ç™ºã§è©°ã¾ã£ãŸã¨ãã«åƒ•ãŒã„ã¤ã‚‚ã‚„ã‚‹ã‚„ã‚Šæ–¹ã§è§£æ±ºã—ã¦ã„ãã¾ã™ã€‚
å¤§ä½“ã“ã‚“ãªæ„Ÿã˜ã§é€²ã‚ã¾ã™ã€‚

1. ã‚¨ãƒ©ãƒ¼ã¨ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦åŸå› ãŒã‚ã‹ã£ã¦ã™ãç›´ã›ãã†ãªã‚‰ç›´ã—ã¦çµ‚ã‚ã‚Šã§ã™ã€‚
2. ãã‚Œã§ã‚‚ã‚ã‹ã‚‰ãªã‘ã‚Œã°ã¾ãšã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¾ã™ã€‚
3. ãã‚Œã§ã‚‚ã‚ã‹ã‚‰ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’èµ·ã“ã—ã¦ã„ã‚‹ã¨ã“ã‚ã«æ½œã‚‰ãªã„ã¨ãŠæ‰‹ä¸Šã’ãªã®ã§ã€ã¾ãšgithubã§å¯¾è±¡ãƒ¬ãƒã‚¸ãƒˆãƒªã‚’æ¤œç´¢ã—ã¾ã™ã€‚
4. ãƒ¬ãƒã‚¸ãƒˆãƒªã®ãƒšãƒ¼ã‚¸ã«è¾¿ã‚Šã¤ã„ãŸã‚‰ãƒ¬ãƒã‚¸ãƒˆãƒªå†…æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼æ–‡ã‚’ããã‚Šã¾ã™ã€‚ä»Šå›ã§ã„ã†ã¨`int`ã®éƒ¨åˆ†ã¯å‹•çš„ã«å–ã£ã¦ããã†ãªã®ã§ã€`Bad field type`ã§æ¤œç´¢ã—ã¾ã™ã€‚
5. å‡ºã¦ããŸã‚‰ãã®å‘¨ã‚Šã‹ã‚‰ç™»ã£ã¦ã„ãã—ã‹ãªã„ã§ã™ã€‚åƒ•ã®ç’°å¢ƒ(vscode)ã§ã¯ãªãœã‹ãƒ‡ãƒãƒƒã‚¬ãƒ¼ãŒå‹•ã‹ãªã„ï¼ˆå‹•ã‹ãã†ã¨ã—ã¦æ–­å¿µã—ãŸï¼‰ã®ã§ãã“ã‹ã‚‰ãŒã‚“ã°ã£ã¦ç™»ã£ã¦ã„ãã¾ã™ã€‚


ãã‚Œã§ã¯æ”¹ã‚ã¦èª¿æŸ»ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
å…ˆã»ã©ç•¥ã—ãŸå ´æ‰€ã‚’ã¿ã¾ã™ã€‚
```sh 
panic(0x74d880, 0xc00031fd60)
	/usr/local/go/src/runtime/panic.go:965 +0x1b9
github.com/go-playground/validator.isUnique(0x8234f8, 0xc000370fc0, 0x7831e0)
	/go/pkg/mod/github.com/go-playground/validator@v9.31.0+incompatible/baked_in.go:260 +0xb1f
github.com/go-playground/validator.wrapFunc.func1(0x820950, 0xc00001a068, 0x8234f8, 0xc000370fc0, 0x74cf80)
	/go/pkg/mod/github.com/go-playground/validator@v9.31.0+incompatible/baked_in.go:35 +0x39
github.com/go-playground/validator.(*validate).traverseField(0xc000370fc0, 0x820950, 0xc00001a068, 0x79fb00, 0xc0000ab270, 0x99, 0x74cf80, 0xc0000ab2a8, 0x82, 0xc000463480, ...)
	/go/pkg/mod/github.com/go-playground/validator@v9.31.0+incompatible/validator.go:445 +0x570
github.com/go-playground/validator.(*validate).validateStruct(0xc000370fc0, 0x820950, 0xc00001a068, 0x79fb00, 0xc0000ab270, 0x99, 0x79fb00, 0xc0000ab270, 0x99, 0x824900, ...)
	/go/pkg/mod/github.com/go-playground/validator@v9.31.0+incompatible/validator.go:77 +0x4e9
github.com/go-playground/validator.(*validate).traverseField(0xc000370fc0, 0x820950, 0xc00001a068, 0x79a0c0, 0xc0000ab1e0, 0x99, 0x79fb00, 0xc0000ab270, 0x99, 0xc000463480, ...)
	/go/pkg/mod/github.com/go-playground/validator@v9.31.0+incompatible/validator.go:225 +0x3d2c
github.com/go-playground/validator.(*validate).validateStruct(0xc000370fc0, 0x820950, 0xc00001a068, 0x79a0c0, 0xc0000ab1e0, 0x99, 0x79a0c0, 0xc0000ab1e0, 0x99, 0x824900, ...)
	/go/pkg/mod/github.com/go-playground/validator@v9.31.0+incompatible/validator.go:77 +0x4e9
github.com/go-playground/validator.(*Validate).StructCtx(0xc00027af60, 0x820950, 0xc00001a068, 0x79a0c0, 0xc0000ab1e0, 0x0, 0x0)
	/go/pkg/mod/github.com/go-playground/validator@v9.31.0+incompatible/validator_instance.go:304 +0x38a
github.com/go-playground/validator.(*Validate).Struct(...)
	/go/pkg/mod/github.com/go-playground/validator@v9.31.0+incompatible/validator_instance.go:277
```

ã©ã†ã‚„ã‚‰validatorãŒæ‚ªãã†ã§ã™ã­ã€‚ã¨ã„ã†ã“ã¨ã§githubã®validatorã®ãƒ¬ãƒã‚¸ãƒˆãƒªã«è¡Œã£ã¦ãƒ¬ãƒã‚¸ãƒˆãƒªã‹ã‚‰æ¤œç´¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã™ã‚‹ã¨å‡ºã¦ãã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/vzmsfkyc7x5ahgfmu8vz6bmtpfhs)

ã»ãƒ¼ã‚“ã€ãªã‚‹ã»ã©ã€å¯¾è±¡ã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºã¦ãã¾ã—ãŸã€‚ã—ã‹ã‚‚ä¸‹ã®æ–¹ã‚’è¦‹ã¦ã¿ã‚‹ã¨ãã‚Œã¨åŒã˜ã‚¨ãƒ©ãƒ¼ãŒèµ·ã“ã‚‹ã‹ã©ã†ã‹ã®ãƒ†ã‚¹ãƒˆã¾ã§ã‚ã‚Šãã†ã§ã™ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã™ã°ã‚‰ã—ã„ã§ã™ã­ã€‚ãã‚Œã§ã¯è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

è¦‹ã¦ã„ãã¨ã€panicã¯`isUnique()`ã§èµ·ã“ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
ãã†ã„ãˆã°ã€ç‹¬è‡ªé–¢æ•°ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’æ¤œæŸ»ã™ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã“ã†æ›¸ã„ã¦ã„ã¾ã—ãŸã€‚

```go
type User struct {
	Email    int `validate:"unique"`
	ç•¥
}
```
ã“ã‚Œã¯ã€ã€ã€uniqueã¯æ—¢ã«æº–å‚™ã•ã‚Œã¦ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã‹ã­ï¼Ÿ
ã“ã®ã‚«ãƒ©ãƒ ãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ã‹ã©ã†ã‹ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å•ã„åˆã‚ã›ã¦ç¢ºèªã™ã‚‹ã®ã§ã€ç‹¬è‡ªã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¨ã„ã†ã“ã¨ã§uniqueã§ã¯ãªãã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã“ã‚“ãªæ„Ÿã˜ã«ã—ã¾ã—ãŸã€‚
```go
type User struct {
	Id  int `validate:"uniqueEmail"`
	ç•¥
}

in validation func
~~~~~~~~~
validate := validator.New()
validate.RegisterValidation("uniqueEmail", ValidateUniqueEmail)
~~~~~~~~~

//ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨é–¢æ•°
func ValidateUniqueEmail(fl validator.FieldLevel) bool {
	//dbã«å•ã„åˆã‚ã›ã¦æ—¢ã«å­˜åœ¨ã—ã¦ã„ã‚Œã°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹

}

```
ã™ã‚‹ã¨ãã¡ã‚“ã¨å‹•ãæ§˜ã«ãªã‚Šã¾ã—ãŸã€‚

# åŸå› 
åŸå› ã¯ç‹¬è‡ªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ã‚’`unique`ã¨ã„ã†åå‰ã§ä½œã£ã¦ãŠã‚Šã€ãã®ãƒ«ãƒ¼ãƒ«ã¯**é…åˆ—ã‚„ã‚¹ãƒ©ã‚¤ã‚¹ã®ä¸­ã«é‡è¤‡ã—ãŸã‚‚ã®ãŒãªã„ã‹**ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚
ä»–ã«ã‚‚èª¿æŸ»ã—ãŸã¨ã“ã‚ã€ãã‚‚ãã‚‚go-playground/validatorã¯ï½„ï½‚ã‚’æ‰±ã†ã«ã¯ä¸å‘ããªã‚ˆã†ã§ã™ã€ã€ã€
ç‹¬è‡ªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦æ›¸ãèµ·ã“ãã†ã‹ã¨æ€ã„ã¾ã™ã€‚ã€‚ã€‚
